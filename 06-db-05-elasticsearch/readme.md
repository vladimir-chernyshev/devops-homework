Домашнее задание к занятию "6.5. Elasticsearch"
===
1. запустите контейнер Elasticsearch из образа Centos 7 и выполните запрос пути */* c хост-машины
---
В ответе приведите:
 -  текст Dockerfile манифеста
 -  ссылку на образ в репозитории dockerhub
 -  ответ elasticsearch на запрос пути / в json виде

	Dockerfile

		FROM centos:7
		EXPOSE 9200
		RUN adduser -mr elastic && mkdir /var/lib/elastic && chown elastic /var/lib/elastic
		USER elastic
		RUN cd && curl https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.0.0-linux-x86_64.tar.gz --output el800.tar.gz && tar -xzf el800.tar.gz && rm el800.tar.gz
		ENV ES_HOME=./elasticsearch-8.0.0
		RUN cd && echo "node.name: netology_test" >> $ES_HOME/config/elasticsearch.yml && echo "path.data: /var/lib/elastic" >> $ES_HOME/config/elasticsearch.yml
		CMD $HOME/$ES_HOME/bin/elasticsearch


		$ docker build .
		[..]
		COMMIT
		--> 8da62f5724e
		8da62f5724eada30f19889601eba99fb058914b73c171538295d2c91db709290
		$ docker run -dp 9200:9200 8da62f5724e
		$ docker ps
		CONTAINER ID  IMAGE        COMMAND               CREATED             STATUS                 PORTS                   NAMES
		04a2e0c6288c  8da62f5724e  /bin/sh -c $HOME/...  About a minute ago  Up About a minute ago  0.0.0.0:9200->9200/tcp  nostalgic_jones

		$ docker exec -it 04a2e0c6288c  /home/elastic/elasticsearch-8.0.0/bin/elasticsearch-reset-password -u elastic
		This tool will reset the password of the [elastic] user to an autogenerated value.
		The password will be printed in the console.
		Please confirm that you would like to continue [y/N]y
		
		
		Password for the [elastic] user successfully reset.
		New value: H6m5adh0bGJXb=qZpyg4

		$ curl -ku elastic https://localhost:9200 
		Enter host password for user 'elastic':
		{
		  "name" : "netology_test",
		  "cluster_name" : "elasticsearch",
		  "cluster_uuid" : "2GOFLlyJQZSOvJpfH784sA",
		  "version" : {
		    "number" : "8.0.0",
		    "build_flavor" : "default",
		    "build_type" : "tar",
		    "build_hash" : "1b6a7ece17463df5ff54a3e1302d825889aa1161",
		    "build_date" : "2022-02-03T16:47:57.507843096Z",
		    "build_snapshot" : false,
		    "lucene_version" : "9.0.0",
		    "minimum_wire_compatibility_version" : "7.17.0",
		    "minimum_index_compatibility_version" : "7.0.0"
		  },
		  "tagline" : "You Know, for Search"
		}

		$  docker tag 8da62f5724e vladimirchernyshev/devops-netology:6.4
		$ docker login docker.io
		Username: vladimirchernyshev
		Password: 
		Login Succeeded!
		$  docker push vladimirchernyshev/devops-netology:6.4

[Ссылка на репозиторий](https://hub.docker.com/repository/docker/vladimirchernyshev/devops-netology)

2. 
---
Ознакомтесь с документацией и добавьте в elasticsearch 3 индекса

		$ curl -ku elastic -X PUT "https://localhost:9200/ind-1" -H 'Content-Type: application/json' -d'
		> {
		>   "settings": {
		>     "index": {
		>       "number_of_shards": 1,
		>       "number_of_replicas": 0
		>     }
		>   }
		> }
		> '
		Enter host password for user 'elastic':
		{"acknowledged":true,"shards_acknowledged":true,"index":"ind-1"}

Аналогично создаем *ind-2* c количеством реплик *1* и количеством шард *2*, *ind-3* с количеством реплик 2 и количеством шард *4*

Получите список индексов и их статусов, используя API 

		$ curl -ku elastic  https://localhost:9200/_cat/indices
		Enter host password for user 'elastic':
		green  open ind-1 LUBiYPPYQcewudZr-myVNw 1 0 0 0 225b 225b
		yellow open ind-3 9LUP0GxpSpqrCYnnSn7dQg 4 2 0 0 900b 900b
		yellow open ind-2 Ktec7tYbSqeR_5pS5znQdw 2 1 0 0 450b 450b

Получите состояние кластера elasticsearch, используя API.
Как вы думаете, почему часть индексов и кластер находится в состоянии yellow?

		$ curl -ku elastic  https://localhost:9200/_cluster/hh?pretty
		Enter host password for user 'elastic':
		{
		  "cluster_name" : "elasticsearch",
		  "status" : "yellow",
		  "timed_out" : false,
		  "number_of_nodes" : 1,
		  "number_of_data_nodes" : 1,
		  "active_primary_shards" : 9,
		  "active_shards" : 9,
		  "relocating_shards" : 0,
		  "initializing_shards" : 0,
		  "unassigned_shards" : 10,
		  "delayed_unassigned_shards" : 0,
		  "number_of_pending_tasks" : 0,
		  "number_of_in_flight_fetch" : 0,
		  "task_max_waiting_in_queue_millis" : 0,
		  "active_shards_percent_as_number" : 47.368421052631575
		}

 "Желтые" индексы созданы с количеством реплик и шард больше фактически имеющихся. Кластер "желтый" потому, что количество unassigned_shards больше нуля.

Удалите все индексы.

		$ curl -ku elastic  -X DELETE https://localhost:9200/ind-1
		Enter host password for user 'elastic':
		{"acknowledged":true}

3.
---

     

Создайте директорию {путь до корневой директории с elasticsearch в образе}/snapshots.

		$ docker exec -it 0a5764a8b82a mkdir /home/elastic/elasticsearch-8.0.0/snapshots

Используя API зарегистрируйте данную директорию как snapshot repository c именем netology_backup

$ curl -ku elastic -X PUT "https://127.0.0.1:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'
{
  "type": "fs",
  "settings": {
    "location": "/home/elastic/elasticsearch-8.0.0/snapshots"
  }
}
'
Enter host password for user 'elastic':
{
  "error" : {
    "root_cause" : [
      {
        "type" : "repository_exception",
        "reason" : "[netology_backup] location [/home/elastic/elasticsearch-8.0.0/snapshots] doesn't match any of the locations specified by path.repo because this setting is empty"
      }
    ],
    "type" : "repository_exception",
    "reason" : "[netology_backup] failed to create repository",
    "caused_by" : {
      "type" : "repository_exception",
      "reason" : "[netology_backup] location [/home/elastic/elasticsearch-8.0.0/snapshots] doesn't match any of the locations specified by path.repo because this setting is empty"
    }
  },
  "status" : 500
}

[Google-fu](https://opster.com/analysis/doesnt-match-any-of-the-locations-specified-by-path-repo-because-this-setting-is-empty/) 

Разместим каталог снапшотов в /var/lib/elastic/snapshots, для этого модифицируем Dockerfile и пересоберем контейнер:

		..
		RUN adduser -mr elastic && mkdir -p /var/lib/elastic/snapshots && chown -R elastic /var/lib/elastic/snapshots
		..

		$docker build .
		..

		$ curl -ku elastic -X PUT "https://127.0.0.1:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'
		{
		  "type": "fs",
		  "settings": {
		    "location": "/var/lib/elastic/snapshots"
		  }
		}
		'

Создайте индекс test с 0 реплик и 1 шардом и приведите в ответе список индексов.

		$ curl -ku elastic -X PUT http://localhost:9200/test -H 'Content-Type: application/json' -d'
		{ "settings":
		 { "number_of_replicas": 0,
		   "number_of_shards": 1 }
		 }
		'
{"acknowledged":true,"shards_acknowledged":true,"index":"test"}

		$ curl -X GET 'http://localhost:9200/_cat/indices?v'
		health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.size
		green  open   test  8AUelgbETem8uCUkF5baXA   1   0          0            0       225b           225b

Создайте snapshot состояния кластера elasticsearch.
Приведите в ответе список файлов в директории со snapshotами.

		$ curl -ku elastic -X PUT http://localhost:9200/_snapshot/netology_backup/elasticsearch?wait_for_completion=true
		{"snapshot": {"snapshot":"elasticsearch", "uuid":"s83fs4KlTnuuQqfjP6e59Q", "repository":"netology_backup","version_id":8000099,"version":"8.0.0","indices":["t0est"],"data_streams":[],"include_global_state":true,"state":"SUCCESS","start_time":"2022-03-02T04:11:05.095Z","start_time_in_millis":1646194265095,"end_time":"2022-03-02T04:11:05.495Z","end_time_in_millis":1646194265495,"duration_in_millis":400,"failures":[],"shards":{"total":1,"failed":0,"successful":1},"feature_states":[]}}

		$ docker exec -it 0a5764a8b82a ls -la /var/lib/elastic/snapshots/
		total 36
		drwxr-xr-x. 1 elasticsearch elasticsearch   176 Mar  2 04:11 .
		drwxr-xr-x. 1 elasticsearch elasticsearch    34 Mar  2 03:56 ..
		-rw-r--r--. 1 elasticsearch elasticsearch   589 Mar  2 04:11 index-0
		-rw-r--r--. 1 elasticsearch elasticsearch     8 Mar  2 04:11 index.latest
		drwxr-xr-x. 1 elasticsearch elasticsearch    44 Mar  2 04:11 indices
		-rw-r--r--. 1 elasticsearch elasticsearch 17135 Mar  2 04:11 meta-s83fs4KlTnuuQqfjP6e59Q.dat
		-rw-r--r--. 1 elasticsearch elasticsearch   308 Mar  2 04:11 snap-s83fs4KlTnuuQqfjP6e59Q.dat

Удалите индекс test и создайте индекс test-2. Приведите в ответе список индексов.
		$ curl -ku elastic -X DELETE 'http://localhost:9200/test?pretty'
		$ curl -ku elastic -X PUT http://localhost:9200/test-2 -H 'Content-Type: application/json' -d'
		{ "settings":
		 { "number_of_replicas": 0,
		   "number_of_shards": 1 }
		 }
		'
		$ curl -ku elastic -X GET 'http://localhost:9200/_cat/indices?v'		
		health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.size
		green  open   test-2 oez0F7msTnydqE0UB5uMBw   1   0          0            0       225b           225b

Восстановите состояние кластера elasticsearch из snapshot, созданного ранее.
Приведите в ответе запрос к API восстановления и итоговый список индексов.

		$ curl -ku elastic -X POST 'http://localhost:9200/.*/_close?pretty'
		{
		  "acknowledged" : true,
		  "shards_acknowledged" : false,
		  "indices" : { }
		}
		$ curl -ku elastic -X POST 'http://localhost:9200/_snapshot/netology_backup/elasticsearch/_restore?wait_for_completion=true'
{
  "snapshot":
  {
    "snapshot":"elasticsearch",
    "indices":["test"],
    "shards":
      {
        "total":1,
        "failed":0,
        "successful":1
      }
   }
}

		$ curl -ku elastic -X GET 'http://localhost:9200/_cat/indices?v'
		health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.size
		green  open   test-2 oez0F7msTnydqE0UB5uMBw   1   0          0            0       247b           247b
		green  open   test   x77pFGEBQr6JLdh4Nu01YQ   1   0          0            0       225b           225b
